<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kusanagi - Agent Controller for K3s Infrastructure">
    <title>Kusanagi | ËçâËñô</title>
    <link rel="stylesheet" href="/static/css/cyberpunk.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>">
</head>

<body>
    <!-- Background Effects -->
    <div class="grid-bg"></div>
    <div class="scanlines"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="logo">KUSANAGI</h1>
            <p class="subtitle">Agent Controller System</p>
            <p class="japanese-text">ËçâËñôÁ¥†Â≠ê // MOTOKO</p>
        </header>

        <!-- Terminal Section -->
        <section class="terminal">
            <div class="terminal-header">
                root@kusanagi:~# ./system_status.sh
            </div>
            <div class="terminal-content">
                <div class="terminal-line">
                    <span class="prompt">$</span> <span class="command">echo</span> <span class="output">"Initializing
                        Kusanagi Agent Controller..."</span>
                </div>
                <div class="terminal-line">
                    <span class="prompt">$</span> <span class="output">System Status: </span><span
                        class="highlight">ONLINE</span>
                </div>
                <div class="terminal-line">
                    <span class="prompt">$</span> <span class="output">Neural Network: </span><span
                        class="highlight">CONNECTED</span>
                </div>
                <div class="terminal-line">
                    <span class="prompt">$</span> <span class="output">Ghost Synchronization: </span><span
                        class="highlight">100%</span>
                </div>
                <div class="terminal-line">
                    <span class="prompt">$</span> <span class="command">ready</span><span class="cursor"></span>
                </div>
            </div>
        </section>

        <!-- ArgoCD Status Section -->
        <section class="argocd-section">
            <h2 class="section-title">ArgoCD Applications Status</h2>

            <div class="argocd-stats" id="argocd-stats">
                <div class="stat-box info">
                    <div class="stat-value" id="stat-total">-</div>
                    <div class="stat-label">Total Apps</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="stat-healthy">-</div>
                    <div class="stat-label">Healthy</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="stat-unhealthy">-</div>
                    <div class="stat-label">Unhealthy</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="stat-synced">-</div>
                    <div class="stat-label">Synced</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="stat-outofsync">-</div>
                    <div class="stat-label">Out of Sync</div>
                </div>
                <div class="stat-box warning">
                    <div class="stat-value" id="stat-progressing">-</div>
                    <div class="stat-label">Progressing</div>
                </div>
                <div class="stat-box info">
                    <div class="stat-value" id="stat-upgrades">-</div>
                    <div class="stat-label">Upgrades</div>
                </div>
            </div>

            <!-- Real Issues Table -->
            <div class="issues-table-container" id="issues-container">
                <div class="issues-table-header">
                    <span class="issues-table-title">‚ö† Real Issues</span>
                    <span class="issues-count" id="issues-count">0</span>
                </div>
                <div id="issues-content">
                    <div class="loading">Loading ArgoCD status...</div>
                </div>
            </div>

            <!-- Upgrades Available Table -->
            <div class="issues-table-container upgrades-container" id="upgrades-container"
                style="margin-top: 2rem; border-color: var(--neon-cyan);">
                <div class="issues-table-header"
                    style="background: rgba(0, 255, 255, 0.1); border-color: var(--neon-cyan);">
                    <span class="issues-table-title" style="color: var(--neon-cyan);">üîÑ Upgrades Available</span>
                    <span class="issues-count" id="upgrades-count" style="background: var(--neon-cyan);">0</span>
                </div>
                <div id="upgrades-content">
                    <div class="no-issues">No upgrades available</div>
                </div>
            </div>
        </section>

        <!-- Nodes Monitoring Section -->
        <section class="argocd-section" style="margin-top: 2rem;">
            <h2 class="section-title">üñ•Ô∏è Cluster Nodes</h2>

            <!-- Node Stats Grid -->
            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-box">
                    <div class="stat-value" id="node-total">-</div>
                    <div class="stat-label">Total Nodes</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="node-ready">-</div>
                    <div class="stat-label">Ready</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="node-notready">-</div>
                    <div class="stat-label">Not Ready</div>
                </div>
            </div>

            <!-- Node Cards Container -->
            <div class="nodes-container" id="nodes-container">
                <div class="loading">Loading nodes status...</div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p class="footer-quote">"Your effort to remain what you are is what limits you."</p>
            <p>KUSANAGI // Ghost in the Shell Inspired // Built with ‚ö° by Rust</p>
        </footer>
    </div>

    <script>
        async function fetchArgoStatus() {
            try {
                const response = await fetch('/api/argocd/status');
                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                updateStats(data);
                updateIssuesTable(data.apps_with_issues);
                updateUpgradesTable(data.apps_with_upgrades);
            } catch (error) {
                showError('Failed to connect to ArgoCD API');
            }
        }

        function updateStats(data) {
            document.getElementById('stat-total').textContent = data.total;
            document.getElementById('stat-healthy').textContent = data.healthy;
            document.getElementById('stat-unhealthy').textContent = data.unhealthy;
            document.getElementById('stat-synced').textContent = data.synced;
            document.getElementById('stat-outofsync').textContent = data.out_of_sync;
            document.getElementById('stat-progressing').textContent = data.progressing;
            document.getElementById('stat-upgrades').textContent = data.upgrades_available || 0;
            document.getElementById('issues-count').textContent = data.apps_with_issues.length;
            document.getElementById('upgrades-count').textContent = (data.apps_with_upgrades || []).length;
        }

        function renderAppRow(app, showSync = false) {
            return `
                <tr>
                    <td class="app-name">
                        <a href="${app.argocd_url}" target="_blank" title="Open in ArgoCD" style="color: var(--neon-green); text-decoration: none;">
                            ${app.name} üîó
                        </a>
                    </td>
                    <td>${app.namespace || '-'}</td>
                    <td><span class="status-badge ${app.health_status.toLowerCase()}">${app.health_status}</span></td>
                    <td><span class="status-badge ${app.sync_status.toLowerCase().replace(' ', '')}">${app.sync_status}</span></td>
                    <td class="error-duration">${app.error_duration || '-'}</td>
                    ${showSync && app.can_sync ? `
                        <td>
                            <button class="sync-btn" onclick="syncApp('${app.name}')" title="Sync ${app.name}">
                                ‚ü≥ Sync
                            </button>
                        </td>
                    ` : `<td class="error-message" title="${app.message || ''}">${app.message || '-'}</td>`}
                </tr>
            `;
        }

        function updateIssuesTable(issues) {
            const container = document.getElementById('issues-content');

            if (!issues || issues.length === 0) {
                container.innerHTML = '<div class="no-issues">All applications are healthy!</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Namespace</th>
                            <th>Health</th>
                            <th>Sync</th>
                            <th>Duration</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${issues.map(app => renderAppRow(app, false)).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        function updateUpgradesTable(upgrades) {
            const container = document.getElementById('upgrades-content');

            if (!upgrades || upgrades.length === 0) {
                container.innerHTML = '<div class="no-issues" style="color: var(--neon-cyan);">No upgrades available</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Namespace</th>
                            <th>Health</th>
                            <th>Sync</th>
                            <th>Duration</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${upgrades.map(app => renderAppRow(app, true)).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        async function syncApp(appName) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Syncing...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/argocd/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ app_name: appName })
                });
                const data = await response.json();

                if (data.success) {
                    btn.textContent = '‚úì Done';
                    btn.style.background = 'var(--neon-green)';
                    setTimeout(() => fetchArgoStatus(), 2000);
                } else {
                    btn.textContent = '‚úó Failed';
                    btn.style.background = '#ff4444';
                    console.error(data.message);
                }
            } catch (error) {
                btn.textContent = '‚úó Error';
                btn.style.background = '#ff4444';
                console.error('Sync failed:', error);
            }

            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '';
            }, 3000);
        }

        function showError(message) {
            const container = document.getElementById('issues-content');
            container.innerHTML = `<div class="loading" style="color: #ff4444;">Error: ${message}</div>`;
        }

        // Initial fetch
        fetchArgoStatus();
        fetchNodesStatus();

        // Refresh every 30 seconds
        setInterval(fetchArgoStatus, 30000);
        setInterval(fetchNodesStatus, 30000);

        // === NODES MONITORING ===
        async function fetchNodesStatus() {
            try {
                const response = await fetch('/api/nodes/status');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('nodes-container').innerHTML =
                        `<div class="loading" style="color: #ff4444;">Error: ${data.error}</div>`;
                    return;
                }

                // Update stats
                document.getElementById('node-total').textContent = data.total_nodes;
                document.getElementById('node-ready').textContent = data.ready_nodes;
                document.getElementById('node-notready').textContent = data.not_ready_nodes;

                // Render nodes
                renderNodes(data.nodes);
            } catch (error) {
                document.getElementById('nodes-container').innerHTML =
                    `<div class="loading" style="color: #ff4444;">Failed to fetch nodes</div>`;
            }
        }

        function renderNodes(nodes) {
            const container = document.getElementById('nodes-container');

            if (!nodes || nodes.length === 0) {
                container.innerHTML = '<div class="no-issues">No nodes found</div>';
                return;
            }

            // Sort nodes: errors first, then by architecture, then by name
            nodes.sort((a, b) => {
                if (a.pods_in_error !== b.pods_in_error) return b.pods_in_error - a.pods_in_error;
                if (a.architecture !== b.architecture) return a.architecture.localeCompare(b.architecture);
                return a.name.localeCompare(b.name);
            });

            const html = nodes.map(node => {
                const archClass = node.architecture === 'arm64' ? 'arch-arm' : 'arch-amd';
                const statusClass = node.status === 'Ready' ? 'node-ready' : 'node-notready';
                const nodeType = node.labels?.type || node.labels?.['node.kubernetes.io/instance-type'] || 'node';
                const podPercent = Math.round((node.pod_count / parseInt(node.pod_capacity)) * 100);
                const podBarClass = podPercent > 80 ? 'bar-danger' : podPercent > 60 ? 'bar-warning' : 'bar-ok';

                return `
                    <div class="node-card ${statusClass} ${node.pods_in_error > 0 ? 'has-errors' : ''}">
                        <div class="node-header">
                            <div class="node-title">
                                <span class="node-name">${node.name}</span>
                                <span class="node-type">${nodeType}</span>
                            </div>
                            <span class="arch-badge ${archClass}">${node.architecture}</span>
                        </div>
                        
                        <div class="node-resources">
                            <div class="resource-row">
                                <span class="resource-icon">‚ö°</span>
                                <span class="resource-label">CPU</span>
                                <span class="resource-value">${node.cpu_capacity} cores</span>
                            </div>
                            <div class="resource-row">
                                <span class="resource-icon">üß†</span>
                                <span class="resource-label">RAM</span>
                                <span class="resource-value">${node.memory_allocatable}</span>
                            </div>
                            <div class="resource-row pods-row">
                                <span class="resource-icon">üì¶</span>
                                <span class="resource-label">Pods</span>
                                <div class="pod-bar-container">
                                    <div class="pod-bar ${podBarClass}" style="width: ${podPercent}%"></div>
                                    <span class="pod-text">${node.pod_count}/${node.pod_capacity}</span>
                                </div>
                            </div>
                        </div>

                        <div class="node-uptime">
                            <span class="uptime-icon">‚è±</span>
                            <span class="uptime-value">${node.uptime || 'Unknown'}</span>
                        </div>

                        ${node.pods_in_error > 0 ? `
                            <div class="node-errors">
                                <div class="error-header">‚ö†Ô∏è ${node.pods_in_error} pod${node.pods_in_error > 1 ? 's' : ''} in error</div>
                                <div class="error-pods">${node.error_pod_names.map(p => `<span class="error-pod">${p}</span>`).join('')}</div>
                            </div>
                        ` : ''}

                        <div class="node-footer">
                            <span class="footer-item" title="${node.kernel_version}">${node.container_runtime.split('://')[0]}</span>
                            <span class="footer-item">${node.kubelet_version}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="nodes-grid">${html}</div>`;
        }
    </script>
</body>

</html>