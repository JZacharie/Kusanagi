<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kusanagi - Agent Controller for K3s Infrastructure">
    <title>Kusanagi | ËçâËñô</title>
    <link rel="stylesheet" href="/static/css/cyberpunk.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>">
    <!-- RUM (Real User Monitoring) -->
    <script src="/static/js/rum.js"></script>
</head>

<body>
    <!-- Background Effects -->
    <div class="grid-bg"></div>
    <div class="scanlines"></div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="logo">KUSANAGI</h1>
            <p class="subtitle">Agent Controller System</p>
            <p class="japanese-text">ËçâËñôÁ¥†Â≠ê // MOTOKO</p>
        </header>

        <!-- Quick Stats & External Links -->
        <nav class="quick-nav">
            <div class="quick-stats">
                <div class="quick-stat" title="Namespaces">
                    <span class="quick-icon">üìÅ</span>
                    <span class="quick-value" id="ns-count">-</span>
                    <span class="quick-label">Namespaces</span>
                </div>
                <div class="quick-stat" title="Persistent Volume Claims">
                    <span class="quick-icon">üíæ</span>
                    <span class="quick-value" id="pvc-count">-</span>
                    <span class="quick-label">PVCs</span>
                </div>
                <div class="quick-stat" title="Total Storage">
                    <span class="quick-icon">üìä</span>
                    <span class="quick-value" id="pvc-capacity">-</span>
                    <span class="quick-label">Storage</span>
                </div>
            </div>
            <div class="external-links">
                <a href="https://grafana.p.zacharie.org" target="_blank" class="ext-link grafana" title="Grafana">
                    <span class="link-icon">üìà</span> Grafana
                </a>
                <a href="https://argocd.p.zacharie.org" target="_blank" class="ext-link argocd" title="ArgoCD">
                    <span class="link-icon">üöÄ</span> ArgoCD
                </a>
                <a href="https://homepage.p.zacharie.org" target="_blank" class="ext-link homepage" title="Homepage">
                    <span class="link-icon">üè†</span> Homepage
                </a>
                <a href="https://o2-openobserve.p.zacharie.org" target="_blank" class="ext-link o2" title="OpenObserve">
                    <span class="link-icon">üëÅÔ∏è</span> O2
                </a>
            </div>
        </nav>

        <!-- Section Tabs Navigation -->
        <div class="section-tabs">
            <button class="tab-btn active" data-tab="argocd" onclick="switchTab('argocd')">
                <span class="tab-icon">üöÄ</span> ArgoCD
            </button>
            <button class="tab-btn" data-tab="nodes" onclick="switchTab('nodes')">
                <span class="tab-icon">üñ•Ô∏è</span> Nodes
            </button>
            <button class="tab-btn" data-tab="storage" onclick="switchTab('storage')">
                <span class="tab-icon">üíæ</span> Storage
            </button>
            <button class="tab-btn" data-tab="events" onclick="switchTab('events')">
                <span class="tab-icon">üîî</span> Events
            </button>
            <button class="tab-btn" data-tab="backups" onclick="switchTab('backups')">
                <span class="tab-icon">üì¶</span> Backups
            </button>
            <button class="tab-btn" data-tab="chat" onclick="switchTab('chat')">
                <span class="tab-icon">üí¨</span> Chat
            </button>
        </div>


        <!-- Terminal Section -->
        <section class="terminal">
            <div class="terminal-header">
                root@kusanagi:~# ./system_status.sh
            </div>
            <div class="terminal-content">
                <div class="terminal-line">
                    <span class="prompt">$</span> <span class="command">echo</span> <span class="output">"Initializing
                        Kusanagi Agent Controller..."</span>
                </div>
                <div class="terminal-line">
                    <span class="prompt">$</span> <span class="output">System Status: </span><span
                        class="highlight">ONLINE</span>
                </div>
                <div class="terminal-line">
                    <span class="prompt">$</span> <span class="output">Neural Network: </span><span
                        class="highlight">CONNECTED</span>
                </div>
                <div class="terminal-line">
                    <span class="prompt">$</span> <span class="output">Ghost Synchronization: </span><span
                        class="highlight">100%</span>
                </div>
                <div class="terminal-line">
                    <span class="prompt">$</span> <span class="command">ready</span><span class="cursor"></span>
                </div>
            </div>
        </section>

        <!-- ArgoCD Status Section -->
        <section class="argocd-section tab-content active" data-tab="argocd">
            <h2 class="section-title">ArgoCD Applications Status</h2>

            <div class="argocd-stats" id="argocd-stats">
                <div class="stat-box info">
                    <div class="stat-value" id="stat-total">-</div>
                    <div class="stat-label">Total Apps</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="stat-healthy">-</div>
                    <div class="stat-label">Healthy</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="stat-unhealthy">-</div>
                    <div class="stat-label">Unhealthy</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="stat-synced">-</div>
                    <div class="stat-label">Synced</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="stat-outofsync">-</div>
                    <div class="stat-label">Out of Sync</div>
                </div>
                <div class="stat-box warning">
                    <div class="stat-value" id="stat-progressing">-</div>
                    <div class="stat-label">Progressing</div>
                </div>
                <div class="stat-box info">
                    <div class="stat-value" id="stat-upgrades">-</div>
                    <div class="stat-label">Upgrades</div>
                </div>
            </div>

            <!-- Real Issues Table -->
            <div class="issues-table-container" id="issues-container">
                <div class="issues-table-header">
                    <span class="issues-table-title">‚ö† Real Issues</span>
                    <span class="issues-count" id="issues-count">0</span>
                </div>
                <div id="issues-content">
                    <div class="loading">Loading ArgoCD status...</div>
                </div>
            </div>

            <!-- Upgrades Available Table -->
            <div class="issues-table-container upgrades-container" id="upgrades-container"
                style="margin-top: 2rem; border-color: var(--neon-cyan);">
                <div class="issues-table-header"
                    style="background: rgba(0, 255, 255, 0.1); border-color: var(--neon-cyan);">
                    <span class="issues-table-title" style="color: var(--neon-cyan);">üîÑ Upgrades Available</span>
                    <span class="issues-count" id="upgrades-count" style="background: var(--neon-cyan);">0</span>
                </div>
                <div id="upgrades-content">
                    <div class="no-issues">No upgrades available</div>
                </div>
            </div>
        </section>

        <!-- Nodes Monitoring Section -->
        <section class="argocd-section tab-content" data-tab="nodes" style="display: none;">
            <h2 class="section-title">üñ•Ô∏è Cluster Nodes</h2>

            <!-- Node Stats Grid -->
            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-box">
                    <div class="stat-value" id="node-total">-</div>
                    <div class="stat-label">Total Nodes</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="node-ready">-</div>
                    <div class="stat-label">Ready</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="node-notready">-</div>
                    <div class="stat-label">Not Ready</div>
                </div>
            </div>

            <!-- Node Cards Container -->
            <div class="nodes-container" id="nodes-container">
                <div class="loading">Loading nodes status...</div>
            </div>
        </section>

        <!-- PVC Monitoring Section -->
        <section class="argocd-section tab-content" data-tab="storage" style="display: none;">
            <h2 class="section-title">üíæ Storage (PVCs)</h2>

            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-box">
                    <div class="stat-value" id="pvc-total-count">-</div>
                    <div class="stat-label">Total PVCs</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="pvc-bound-count">-</div>
                    <div class="stat-label">Bound</div>
                </div>
                <div class="stat-box warning">
                    <div class="stat-value" id="pvc-pending-count">-</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-box info">
                    <div class="stat-value" id="pvc-total-storage">-</div>
                    <div class="stat-label">Total Capacity</div>
                </div>
            </div>

            <div class="issues-table-container" id="pvc-container" style="border-color: var(--neon-cyan);">
                <div class="issues-table-header"
                    style="background: rgba(0, 255, 255, 0.1); border-color: var(--neon-cyan);">
                    <span class="issues-table-title" style="color: var(--neon-cyan);">üìä PVC Details</span>
                    <span class="issues-count" id="pvc-table-count" style="background: var(--neon-cyan);">0</span>
                </div>
                <div id="pvc-content">
                    <div class="loading">Loading PVC data...</div>
                </div>
            </div>
        </section>

        <!-- Kubernetes Events Section -->
        <section class="argocd-section tab-content" data-tab="events" style="display: none;">
            <h2 class="section-title">üîî Kubernetes Events (Last Hour)</h2>

            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-box">
                    <div class="stat-value" id="events-total">-</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="events-warnings">-</div>
                    <div class="stat-label">Warnings</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="events-normal">-</div>
                    <div class="stat-label">Normal</div>
                </div>
            </div>

            <div class="issues-table-container" id="events-container" style="border-color: var(--neon-magenta);">
                <div class="issues-table-header"
                    style="background: rgba(255, 0, 128, 0.1); border-color: var(--neon-magenta);">
                    <span class="issues-table-title" style="color: var(--neon-magenta);">‚ö†Ô∏è Recent Events</span>
                    <span class="issues-count" id="events-table-count" style="background: var(--neon-magenta);">0</span>
                </div>
                <div id="events-content">
                    <div class="loading">Loading events...</div>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section class="argocd-section tab-content" data-tab="chat" style="display: none;">
            <h2 class="section-title">üí¨ Kusanagi Chat</h2>

            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message bot">
                        <div class="message-content">
                            <span class="bot-header"><img src="/static/images/logo.png" class="chat-avatar"
                                    alt="Kusanagi"> <strong>Kusanagi</strong></span><br>
                            Welcome! Type <code>/help</code> for available commands, or ask me about your cluster
                            status.
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" class="chat-input"
                        placeholder="Type a command or question... (e.g., /status, /nodes, /events)"
                        onkeypress="handleChatKeypress(event)">
                    <button class="chat-send-btn" onclick="sendChatMessage()">Send ‚û§</button>
                </div>
            </div>
        </section>

        <!-- Backups Section -->
        <section class="argocd-section tab-content" data-tab="backups" style="display: none;">
            <h2 class="section-title">üì¶ Backup Jobs Status</h2>

            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-box">
                    <div class="stat-value" id="backup-cronjobs">-</div>
                    <div class="stat-label">CronJobs</div>
                </div>
                <div class="stat-box warning">
                    <div class="stat-value" id="backup-active">-</div>
                    <div class="stat-label">Running</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="backup-succeeded">-</div>
                    <div class="stat-label">Succeeded</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="backup-failed">-</div>
                    <div class="stat-label">Failed</div>
                </div>
            </div>

            <div class="issues-table-container" id="backups-container" style="border-color: var(--neon-green);">
                <div class="issues-table-header"
                    style="background: rgba(0, 255, 136, 0.1); border-color: var(--neon-green);">
                    <span class="issues-table-title" style="color: var(--neon-green);">‚è∞ CronJobs & Recent Jobs</span>
                    <span class="issues-count" id="backups-count" style="background: var(--neon-green);">0</span>
                </div>
                <div id="backups-content">
                    <div class="loading">Loading backup jobs...</div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p class="footer-quote">"Your effort to remain what you are is what limits you."</p>
            <p>KUSANAGI // Ghost in the Shell Inspired // Built with ‚ö° by Rust</p>
        </footer>
    </div>

    <script>
        // === TAB NAVIGATION ===
        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });

            // Update content
            document.querySelectorAll('.tab-content').forEach(section => {
                if (section.dataset.tab === tabName) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        // === CHAT FUNCTIONS ===
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addChatMessage(message, 'user');
            input.value = '';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                addChatMessage(data.response, 'bot');
            } catch (error) {
                addChatMessage('Error: Failed to get response from server', 'bot');
            }
        }

        function addChatMessage(content, type) {
            const container = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;

            // Simple markdown to HTML conversion
            let html = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>')
                .replace(/^## (.*)/gm, '<h4>$1</h4>')
                .replace(/^- (.*)/gm, '‚Ä¢ $1<br>');

            if (type === 'user') {
                messageDiv.innerHTML = `<div class="message-content"><strong>üë§ You</strong><br>${html}</div>`;
            } else {
                messageDiv.innerHTML = `<div class="message-content"><span class="bot-header"><img src="/static/images/logo.png" class="chat-avatar" alt="Kusanagi"> <strong>Kusanagi</strong></span><br>${html}</div>`;
            }

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // === ARGOCD ===
        async function fetchArgoStatus() {
            try {
                const response = await fetch('/api/argocd/status');
                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                updateStats(data);
                updateIssuesTable(data.apps_with_issues);
                updateUpgradesTable(data.apps_with_upgrades);
            } catch (error) {
                showError('Failed to connect to ArgoCD API');
            }
        }

        function updateStats(data) {
            document.getElementById('stat-total').textContent = data.total;
            document.getElementById('stat-healthy').textContent = data.healthy;
            document.getElementById('stat-unhealthy').textContent = data.unhealthy;
            document.getElementById('stat-synced').textContent = data.synced;
            document.getElementById('stat-outofsync').textContent = data.out_of_sync;
            document.getElementById('stat-progressing').textContent = data.progressing;
            document.getElementById('stat-upgrades').textContent = data.upgrades_available || 0;
            document.getElementById('issues-count').textContent = data.apps_with_issues.length;
            document.getElementById('upgrades-count').textContent = (data.apps_with_upgrades || []).length;
        }

        function renderAppRow(app, showSync = false) {
            return `
                <tr>
                    <td class="app-name">
                        <a href="${app.argocd_url}" target="_blank" title="Open in ArgoCD" style="color: var(--neon-green); text-decoration: none;">
                            ${app.name} üîó
                        </a>
                    </td>
                    <td>${app.namespace || '-'}</td>
                    <td><span class="status-badge ${app.health_status.toLowerCase()}">${app.health_status}</span></td>
                    <td><span class="status-badge ${app.sync_status.toLowerCase().replace(' ', '')}">${app.sync_status}</span></td>
                    <td class="error-duration">${app.error_duration || '-'}</td>
                    ${showSync && app.can_sync ? `
                        <td>
                            <button class="sync-btn" onclick="syncApp('${app.name}')" title="Sync ${app.name}">
                                ‚ü≥ Sync
                            </button>
                        </td>
                    ` : `<td class="error-message" title="${app.message || ''}">${app.message || '-'}</td>`}
                </tr>
            `;
        }

        function updateIssuesTable(issues) {
            const container = document.getElementById('issues-content');

            if (!issues || issues.length === 0) {
                container.innerHTML = '<div class="no-issues">All applications are healthy!</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Namespace</th>
                            <th>Health</th>
                            <th>Sync</th>
                            <th>Duration</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${issues.map(app => renderAppRow(app, false)).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        function updateUpgradesTable(upgrades) {
            const container = document.getElementById('upgrades-content');

            if (!upgrades || upgrades.length === 0) {
                container.innerHTML = '<div class="no-issues" style="color: var(--neon-cyan);">No upgrades available</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Namespace</th>
                            <th>Health</th>
                            <th>Sync</th>
                            <th>Duration</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${upgrades.map(app => renderAppRow(app, true)).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        async function syncApp(appName) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Syncing...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/argocd/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ app_name: appName })
                });
                const data = await response.json();

                if (data.success) {
                    btn.textContent = '‚úì Done';
                    btn.style.background = 'var(--neon-green)';
                    setTimeout(() => fetchArgoStatus(), 2000);
                } else {
                    btn.textContent = '‚úó Failed';
                    btn.style.background = '#ff4444';
                    console.error(data.message);
                }
            } catch (error) {
                btn.textContent = '‚úó Error';
                btn.style.background = '#ff4444';
                console.error('Sync failed:', error);
            }

            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '';
            }, 3000);
        }

        function showError(message) {
            const container = document.getElementById('issues-content');
            container.innerHTML = `<div class="loading" style="color: #ff4444;">Error: ${message}</div>`;
        }

        // Initial fetch
        fetchArgoStatus();
        fetchNodesStatus();

        // Refresh every 30 seconds
        setInterval(fetchArgoStatus, 30000);
        setInterval(fetchNodesStatus, 30000);

        // === NODES MONITORING ===
        async function fetchNodesStatus() {
            try {
                const response = await fetch('/api/nodes/status');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('nodes-container').innerHTML =
                        `<div class="loading" style="color: #ff4444;">Error: ${data.error}</div>`;
                    return;
                }

                // Update stats
                document.getElementById('node-total').textContent = data.total_nodes;
                document.getElementById('node-ready').textContent = data.ready_nodes;
                document.getElementById('node-notready').textContent = data.not_ready_nodes;

                // Render nodes
                renderNodes(data.nodes);
            } catch (error) {
                document.getElementById('nodes-container').innerHTML =
                    `<div class="loading" style="color: #ff4444;">Failed to fetch nodes</div>`;
            }
        }

        function renderNodes(nodes) {
            const container = document.getElementById('nodes-container');

            if (!nodes || nodes.length === 0) {
                container.innerHTML = '<div class="no-issues">No nodes found</div>';
                return;
            }

            // Sort nodes: errors first, then by architecture, then by name
            nodes.sort((a, b) => {
                if (a.pods_in_error !== b.pods_in_error) return b.pods_in_error - a.pods_in_error;
                if (a.architecture !== b.architecture) return a.architecture.localeCompare(b.architecture);
                return a.name.localeCompare(b.name);
            });

            const html = nodes.map(node => {
                const archClass = node.architecture === 'arm64' ? 'arch-arm' : 'arch-amd';
                const statusClass = node.status === 'Ready' ? 'node-ready' : 'node-notready';
                const nodeType = node.labels?.type || node.labels?.['node.kubernetes.io/instance-type'] || 'node';
                const podPercent = Math.round((node.pod_count / parseInt(node.pod_capacity)) * 100);
                const podBarClass = podPercent > 80 ? 'bar-danger' : podPercent > 60 ? 'bar-warning' : 'bar-ok';

                return `
                    <div class="node-card ${statusClass} ${node.pods_in_error > 0 ? 'has-errors' : ''}">
                        <div class="node-header">
                            <div class="node-title">
                                <span class="node-name">${node.name}</span>
                                <span class="node-type">${nodeType}</span>
                            </div>
                            <span class="arch-badge ${archClass}">${node.architecture}</span>
                        </div>
                        
                        <div class="node-resources">
                            <div class="resource-row">
                                <span class="resource-icon">‚ö°</span>
                                <span class="resource-label">CPU</span>
                                <span class="resource-value">${node.cpu_capacity} cores</span>
                            </div>
                            <div class="resource-row">
                                <span class="resource-icon">üß†</span>
                                <span class="resource-label">RAM</span>
                                <span class="resource-value">${node.memory_allocatable}</span>
                            </div>
                            <div class="resource-row pods-row">
                                <span class="resource-icon">üì¶</span>
                                <span class="resource-label">Pods</span>
                                <div class="pod-bar-container">
                                    <div class="pod-bar ${podBarClass}" style="width: ${podPercent}%"></div>
                                    <span class="pod-text">${node.pod_count}/${node.pod_capacity}</span>
                                </div>
                            </div>
                        </div>

                        <div class="node-uptime">
                            <span class="uptime-icon">‚è±</span>
                            <span class="uptime-value">${node.uptime || 'Unknown'}</span>
                        </div>

                        ${node.pods_in_error > 0 ? `
                            <div class="node-errors">
                                <div class="error-header">‚ö†Ô∏è ${node.pods_in_error} pod${node.pods_in_error > 1 ? 's' : ''} in error</div>
                                <div class="error-pods">${node.error_pod_names.map(p => `<span class="error-pod">${p}</span>`).join('')}</div>
                            </div>
                        ` : ''}

                        <div class="node-footer">
                            <span class="footer-item" title="${node.kernel_version}">${node.container_runtime.split('://')[0]}</span>
                            <span class="footer-item">${node.kubelet_version}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="nodes-grid">${html}</div>`;
        }

        // === CLUSTER OVERVIEW ===
        async function fetchClusterOverview() {
            try {
                const response = await fetch('/api/cluster/overview');
                const data = await response.json();

                if (!data.error) {
                    // Quick nav stats
                    document.getElementById('ns-count').textContent = data.namespace_count || 0;
                    document.getElementById('pvc-count').textContent = data.pvc_count || 0;
                    document.getElementById('pvc-capacity').textContent = data.pvc_total_capacity || '-';

                    // PVC section stats
                    const pvcs = data.pvcs || [];
                    const bound = pvcs.filter(p => p.status === 'Bound').length;
                    const pending = pvcs.filter(p => p.status !== 'Bound').length;

                    document.getElementById('pvc-total-count').textContent = data.pvc_count || 0;
                    document.getElementById('pvc-bound-count').textContent = bound;
                    document.getElementById('pvc-pending-count').textContent = pending;
                    document.getElementById('pvc-total-storage').textContent = data.pvc_total_capacity || '-';
                    document.getElementById('pvc-table-count').textContent = pvcs.length;

                    // Render PVC table
                    renderPvcTable(pvcs);
                }
            } catch (error) {
                console.error('Failed to fetch cluster overview:', error);
            }
        }

        function renderPvcTable(pvcs) {
            const container = document.getElementById('pvc-content');

            if (!pvcs || pvcs.length === 0) {
                container.innerHTML = '<div class="no-issues" style="color: var(--neon-cyan);">No PVCs found</div>';
                return;
            }

            // Sort by capacity (largest first)
            pvcs.sort((a, b) => b.capacity_bytes - a.capacity_bytes);

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Namespace</th>
                            <th>Capacity</th>
                            <th>Storage Class</th>
                            <th>Status</th>
                            <th>Access</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pvcs.slice(0, 20).map(pvc => `
                            <tr>
                                <td class="app-name">${pvc.name}</td>
                                <td>${pvc.namespace}</td>
                                <td><span class="pvc-capacity">${pvc.capacity}</span></td>
                                <td><span class="storage-class">${pvc.storage_class || '-'}</span></td>
                                <td><span class="status-badge ${pvc.status.toLowerCase()}">${pvc.status}</span></td>
                                <td class="access-modes">${pvc.access_modes.join(', ')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${pvcs.length > 20 ? `<div class="table-footer">Showing 20 of ${pvcs.length} PVCs</div>` : ''}
            `;
            container.innerHTML = table;
        }
        // === KUBERNETES EVENTS ===
        async function fetchEvents() {
            try {
                const response = await fetch('/api/events');
                const data = await response.json();

                if (!data.error) {
                    document.getElementById('events-total').textContent = data.total_events || 0;
                    document.getElementById('events-warnings').textContent = data.warning_count || 0;
                    document.getElementById('events-normal').textContent = data.normal_count || 0;
                    document.getElementById('events-table-count').textContent = data.events?.length || 0;

                    renderEventsTable(data.events || []);
                }
            } catch (error) {
                console.error('Failed to fetch events:', error);
            }
        }

        function renderEventsTable(events) {
            const container = document.getElementById('events-content');

            if (!events || events.length === 0) {
                container.innerHTML = '<div class="no-issues" style="color: var(--neon-magenta);">No events in the last hour ‚úì</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Object</th>
                            <th>Reason</th>
                            <th>Message</th>
                            <th>Age</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${events.slice(0, 30).map(evt => `
                            <tr class="${evt.event_type.toLowerCase()}">
                                <td><span class="event-type ${evt.event_type.toLowerCase()}">${evt.event_type}</span></td>
                                <td class="event-object">${evt.involved_object_kind}/${evt.involved_object_name.substring(0, 30)}${evt.involved_object_name.length > 30 ? '...' : ''}</td>
                                <td class="event-reason">${evt.reason}</td>
                                <td class="event-message" title="${evt.message}">${evt.message.substring(0, 60)}${evt.message.length > 60 ? '...' : ''}</td>
                                <td class="event-age">${evt.age || '-'}</td>
                                <td class="event-count">${evt.count}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${events.length > 30 ? `<div class="table-footer">Showing 30 of ${events.length} events</div>` : ''}
            `;
            container.innerHTML = table;
        }

        // === BACKUPS ===
        async function fetchBackupsStatus() {
            try {
                const response = await fetch('/api/backups');
                const data = await response.json();

                if (!data.error) {
                    document.getElementById('backup-cronjobs').textContent = data.total_cronjobs || 0;
                    document.getElementById('backup-active').textContent = data.active_jobs || 0;
                    document.getElementById('backup-succeeded').textContent = data.succeeded_jobs || 0;
                    document.getElementById('backup-failed').textContent = data.failed_jobs || 0;
                    document.getElementById('backups-count').textContent = data.total_cronjobs || 0;

                    renderBackupsTable(data.cronjobs || []);
                }
            } catch (error) {
                console.error('Failed to fetch backups:', error);
                document.getElementById('backups-content').innerHTML =
                    '<div class="loading" style="color: #ff4444;">Failed to load backups</div>';
            }
        }

        function renderBackupsTable(cronjobs) {
            const container = document.getElementById('backups-content');

            if (!cronjobs || cronjobs.length === 0) {
                container.innerHTML = '<div class="no-issues" style="color: var(--neon-green);">No CronJobs found</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>CronJob</th>
                            <th>Namespace</th>
                            <th>Schedule</th>
                            <th>Last Run</th>
                            <th>Status</th>
                            <th>Recent Jobs</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cronjobs.map(cj => {
                const statusClass = cj.suspend ? 'suspended' : (cj.active_jobs > 0 ? 'running' : 'healthy');
                const statusText = cj.suspend ? 'Suspended' : (cj.active_jobs > 0 ? 'Running' : 'Idle');

                const recentJobs = (cj.recent_jobs || []).slice(0, 3).map(job => {
                    const jobClass = job.status.toLowerCase();
                    return `<span class="job-badge ${jobClass}" title="${job.name}\nDuration: ${job.duration || '-'}">${job.status === 'Succeeded' ? '‚úì' : job.status === 'Failed' ? '‚úó' : '‚óè'}</span>`;
                }).join(' ');

                return `
                                <tr>
                                    <td class="app-name">${cj.name}</td>
                                    <td>${cj.namespace}</td>
                                    <td><code class="schedule">${cj.schedule}</code></td>
                                    <td class="last-run">${cj.last_schedule_age || '-'}</td>
                                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                    <td class="recent-jobs">${recentJobs || '-'}</td>
                                </tr>
                            `;
            }).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        // Initialize RUM tracking
        if (typeof KusanagiRUM !== 'undefined') {
            KusanagiRUM.init({
                serviceName: 'kusanagi',
                serviceVersion: '0.6.0',
                environment: 'production',
                debug: false
            });
        }

        // Initial fetches
        fetchArgoStatus();
        fetchNodesStatus();
        fetchClusterOverview();
        fetchEvents();
        fetchBackupsStatus();

        // Refresh intervals
        setInterval(fetchArgoStatus, 30000);
        setInterval(fetchNodesStatus, 30000);
        setInterval(fetchClusterOverview, 60000);
        setInterval(fetchEvents, 30000);
        setInterval(fetchBackupsStatus, 60000);

        // Track session stats every 5 minutes
        setInterval(() => {
            if (typeof KusanagiRUM !== 'undefined') {
                const stats = KusanagiRUM.getSessionStats();
                console.log('üìä Session Stats:', stats);
            }
        }, 300000);
    </script>
</body>

</html>