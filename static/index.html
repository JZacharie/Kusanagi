<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kusanagi - Agent Controller for K3s Infrastructure">
    <title>Kusanagi | ËçâËñô</title>
    <link rel="stylesheet" href="/static/css/cyberpunk.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>">
    <!-- RUM (Real User Monitoring) -->
    <script src="/static/js/rum.js"></script>
</head>

<body>
    <!-- Background Effects -->
    <div class="grid-bg"></div>
    <div class="scanlines"></div>

    <!-- Notification Container -->
    <div class="notification-container" id="notification-container"></div>
    <div class="ws-status" id="ws-status" title="WebSocket connection status">
        <span class="ws-indicator disconnected" id="ws-indicator"></span>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="header">
            <button class="theme-toggle" id="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                <span class="theme-icon" id="theme-icon">üåô</span>
            </button>
            <h1 class="logo">KUSANAGI</h1>
            <p class="subtitle">Agent Controller System</p>
            <p class="japanese-text">ËçâËñôÁ¥†Â≠ê // MOTOKO</p>
        </header>

        <!-- Quick Stats & External Links -->
        <nav class="quick-nav">
            <div class="quick-stats">
                <div class="quick-stat" title="Namespaces">
                    <span class="quick-icon">üìÅ</span>
                    <span class="quick-value" id="ns-count">-</span>
                    <span class="quick-label">Namespaces</span>
                </div>
                <div class="quick-stat" title="Persistent Volume Claims">
                    <span class="quick-icon">üíæ</span>
                    <span class="quick-value" id="pvc-count">-</span>
                    <span class="quick-label">PVCs</span>
                </div>
                <div class="quick-stat" title="Total Storage">
                    <span class="quick-icon">üìä</span>
                    <span class="quick-value" id="pvc-capacity">-</span>
                    <span class="quick-label">Storage</span>
                </div>
            </div>
            <div class="external-links">
                <a href="https://grafana.p.zacharie.org" target="_blank" class="ext-link grafana" title="Grafana">
                    <span class="link-icon">üìà</span> Grafana
                </a>
                <a href="https://argocd.p.zacharie.org" target="_blank" class="ext-link argocd" title="ArgoCD">
                    <span class="link-icon">
                        <svg viewBox="0 0 128 128" width="1em" height="1em" fill="currentColor">
                            <path
                                d="M70.089 26.264c-11.411-6.789-25.108-8.22-37.713-4.746C17.432 25.636 5.38 37.116.079 51.603q-.024.066-.051.002-.009-.025-.021-.048-.011-.024-.005-.05 5.007-19.766 21.5-31.155c18.216-12.576 42.79-12.044 60.643.992a.114.114 0 0 1-.023.2l-11.654 4.748a.428.426-40.7 0 1-.38-.028zM71.325 26.978a.03.03 0 0 1 .004-.053l11.754-4.79a.159.157 53.2 0 1 .157.022q15.7 12.43 19.523 31.957c1.583 8.085.993 16.763-1.342 24.58-6.383 21.37-26.086 36.61-48.391 37.292q-1.702.053-.017-.197 15.939-2.362 27.578-14.218c9.91-10.092 14.767-24.64 13.257-38.754q-1.105-10.342-6.506-19.415-5.976-10.043-16.017-16.424z" />
                            <path
                                d="M110.985 10.209h.22Q126.873 27.613 128 51.114v4.793q-1.1 23.145-16.098 40.192c-12.77 14.514-31.675 22.415-51.067 21.64q-1.181-.049-2.343-.21-.007-.002 0-.002 21.11-.9 36.825-14.431c12.675-10.914 20.095-27.247 20.07-44.035-.026-16.352-6.81-31.694-18.68-42.812a.131.131 0 0 1 .207-.087z" />
                        </svg>
                    </span> ArgoCD
                </a>
                <a href="https://homepage.p.zacharie.org" target="_blank" class="ext-link homepage" title="Homepage">
                    <span class="link-icon">üè†</span> Homepage
                </a>
                <a href="https://o2-openobserve.p.zacharie.org" target="_blank" class="ext-link o2" title="OpenObserve">
                    <span class="link-icon">üëÅÔ∏è</span> O2
                </a>
            </div>
        </nav>

        <!-- Section Tabs Navigation -->
        <div class="section-tabs">
            <button class="tab-btn active" data-tab="argocd" onclick="switchTab('argocd')">
                <span class="tab-icon">
                    <svg viewBox="0 0 128 128" width="1em" height="1em" fill="currentColor">
                        <path
                            d="M70.089 26.264c-11.411-6.789-25.108-8.22-37.713-4.746C17.432 25.636 5.38 37.116.079 51.603q-.024.066-.051.002-.009-.025-.021-.048-.011-.024-.005-.05 5.007-19.766 21.5-31.155c18.216-12.576 42.79-12.044 60.643.992a.114.114 0 0 1-.023.2l-11.654 4.748a.428.426-40.7 0 1-.38-.028zM71.325 26.978a.03.03 0 0 1 .004-.053l11.754-4.79a.159.157 53.2 0 1 .157.022q15.7 12.43 19.523 31.957c1.583 8.085.993 16.763-1.342 24.58-6.383 21.37-26.086 36.61-48.391 37.292q-1.702.053-.017-.197 15.939-2.362 27.578-14.218c9.91-10.092 14.767-24.64 13.257-38.754q-1.105-10.342-6.506-19.415-5.976-10.043-16.017-16.424z" />
                        <path
                            d="M110.985 10.209h.22Q126.873 27.613 128 51.114v4.793q-1.1 23.145-16.098 40.192c-12.77 14.514-31.675 22.415-51.067 21.64q-1.181-.049-2.343-.21-.007-.002 0-.002 21.11-.9 36.825-14.431c12.675-10.914 20.095-27.247 20.07-44.035-.026-16.352-6.81-31.694-18.68-42.812a.131.131 0 0 1 .207-.087z" />
                    </svg>
                </span> ArgoCD
            </button>
            <button class="tab-btn" data-tab="nodes" onclick="switchTab('nodes')">
                <span class="tab-icon">
                    <svg viewBox="0 0 24 24" width="1em" height="1em" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2" />
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2" />
                        <line x1="6" y1="6" x2="6.01" y2="6" />
                        <line x1="6" y1="18" x2="6.01" y2="18" />
                    </svg>
                </span> Nodes
            </button>
            <button class="tab-btn" data-tab="storage" onclick="switchTab('storage')">
                <span class="tab-icon">
                    <svg viewBox="0 0 24 24" width="1em" height="1em" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <ellipse cx="12" cy="5" rx="9" ry="3" />
                        <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3" />
                        <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5" />
                    </svg>
                </span> Storage
            </button>
            <button class="tab-btn" data-tab="services" onclick="switchTab('services')">
                <span class="tab-icon">
                    <svg viewBox="0 0 24 24" width="1em" height="1em" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="2" y1="12" x2="22" y2="12" />
                        <path
                            d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                    </svg>
                </span> Services
            </button>
            <button class="tab-btn" data-tab="ingress" onclick="switchTab('ingress')">
                <span class="tab-icon">
                    <svg viewBox="0 0 24 24" width="1em" height="1em" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="2" y1="12" x2="22" y2="12" />
                        <path
                            d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
                    </svg>
                </span> Ingress
            </button>
            <button class="tab-btn" data-tab="events" onclick="switchTab('events')">
                <span class="tab-icon">üîî</span> Events
            </button>
            <button class="tab-btn" data-tab="pods" onclick="switchTab('pods')">
                <span class="tab-icon">üê≥</span> Pods
            </button>
            <button class="tab-btn" data-tab="backups" onclick="switchTab('backups')">
                <span class="tab-icon">üì¶</span> Backups
            </button>
            <button class="tab-btn" data-tab="chat" onclick="switchTab('chat')">
                <span class="tab-icon">üí¨</span> Chat
            </button>
        </div>




        <!-- ArgoCD Status Section -->
        <section class="argocd-section tab-content active" data-tab="argocd">
            <h2 class="section-title">ArgoCD Applications Status</h2>

            <div class="argocd-stats" id="argocd-stats">
                <div class="stat-box info">
                    <div class="stat-value" id="stat-total">-</div>
                    <div class="stat-label">Total Apps</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="stat-healthy">-</div>
                    <div class="stat-label">Healthy</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="stat-unhealthy">-</div>
                    <div class="stat-label">Unhealthy</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="stat-synced">-</div>
                    <div class="stat-label">Synced</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="stat-outofsync">-</div>
                    <div class="stat-label">Out of Sync</div>
                </div>
                <div class="stat-box warning">
                    <div class="stat-value" id="stat-progressing">-</div>
                    <div class="stat-label">Progressing</div>
                </div>
                <div class="stat-box info">
                    <div class="stat-value" id="stat-upgrades">-</div>
                    <div class="stat-label">Upgrades</div>
                </div>
            </div>

            <!-- Real Issues Table -->
            <div class="issues-table-container" id="issues-container">
                <div class="issues-table-header">
                    <span class="issues-table-title">‚ö† Real Issues</span>
                    <span class="issues-count" id="issues-count">0</span>
                </div>
                <div id="issues-content">
                    <div class="loading">Loading ArgoCD status...</div>
                </div>
            </div>

            <!-- Upgrades Available Table -->
            <div class="issues-table-container upgrades-container" id="upgrades-container"
                style="margin-top: 2rem; border-color: var(--neon-cyan);">
                <div class="issues-table-header"
                    style="background: rgba(0, 255, 255, 0.1); border-color: var(--neon-cyan);">
                    <span class="issues-table-title" style="color: var(--neon-cyan);">üîÑ Upgrades Available</span>
                    <span class="issues-count" id="upgrades-count" style="background: var(--neon-cyan);">0</span>
                </div>
                <div id="upgrades-content">
                    <div class="no-issues">No upgrades available</div>
                </div>
            </div>
        </section>

        <!-- Nodes Monitoring Section -->
        <section class="argocd-section tab-content" data-tab="nodes" style="display: none;">
            <h2 class="section-title">üñ•Ô∏è Cluster Nodes</h2>

            <!-- Node Stats Grid -->
            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-box">
                    <div class="stat-value" id="node-total">-</div>
                    <div class="stat-label">Total Nodes</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="node-ready">-</div>
                    <div class="stat-label">Ready</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="node-notready">-</div>
                    <div class="stat-label">Not Ready</div>
                </div>
            </div>

            <!-- Node Cards Container -->
            <div class="nodes-container" id="nodes-container">
                <div class="loading">Loading nodes status...</div>
            </div>
        </section>

        <!-- PVC Monitoring Section -->
        <section class="argocd-section tab-content" data-tab="storage" style="display: none;">
            <h2 class="section-title">üíæ Storage (PVCs)</h2>

            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-box">
                    <div class="stat-value" id="pvc-total-count">-</div>
                    <div class="stat-label">Total PVCs</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="pvc-bound-count">-</div>
                    <div class="stat-label">Bound</div>
                </div>
                <div class="stat-box warning">
                    <div class="stat-value" id="pvc-pending-count">-</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-box info">
                    <div class="stat-value" id="pvc-total-storage">-</div>
                    <div class="stat-label">Total Capacity</div>
                </div>
            </div>

            <div class="issues-table-container" id="pvc-container" style="border-color: var(--neon-cyan);">
                <div class="issues-table-header"
                    style="background: rgba(0, 255, 255, 0.1); border-color: var(--neon-cyan);">
                    <span class="issues-table-title" style="color: var(--neon-cyan);">üìä PVC Details</span>
                    <span class="issues-count" id="pvc-table-count" style="background: var(--neon-cyan);">0</span>
                </div>
                <div id="pvc-content">
                    <div class="loading">Loading PVC data...</div>
                </div>
            </div>
        </section>

        <!-- Services Section -->
        <section class="argocd-section tab-content" data-tab="services" style="display: none;">
            <h2 class="section-title">üåê Services</h2>
            <div class="issues-table-container" id="services-container">
                <div class="issues-table-header">
                    <span class="issues-table-title">Cluster Services</span>
                    <span class="issues-count" id="services-count">0</span>
                </div>
                <div id="services-content">
                    <div class="loading">Loading services...</div>
                </div>
            </div>
        </section>

        <!-- Ingress Section -->
        <section class="argocd-section tab-content" data-tab="ingress" style="display: none;">
            <h2 class="section-title">üåç Ingress Rules</h2>
            <div class="issues-table-container" id="ingress-container">
                <div class="issues-table-header">
                    <span class="issues-table-title">Ingress Routes</span>
                    <span class="issues-count" id="ingress-count">0</span>
                </div>
                <div id="ingress-content">
                    <div class="loading">Loading ingress rules...</div>
                </div>
            </div>
        </section>

        <!-- Kubernetes Events Section -->
        <section class="argocd-section tab-content" data-tab="events" style="display: none;">
            <h2 class="section-title">üîî Kubernetes Events (Last Hour)</h2>

            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-box">
                    <div class="stat-value" id="events-total">-</div>
                    <div class="stat-label">Total Events</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="events-warnings">-</div>
                    <div class="stat-label">Warnings</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="events-normal">-</div>
                    <div class="stat-label">Normal</div>
                </div>
            </div>

            <div class="issues-table-container" id="events-container" style="border-color: var(--neon-magenta);">
                <div class="issues-table-header"
                    style="background: rgba(255, 0, 128, 0.1); border-color: var(--neon-magenta);">
                    <span class="issues-table-title" style="color: var(--neon-magenta);">‚ö†Ô∏è Recent Events</span>
                    <span class="issues-count" id="events-table-count" style="background: var(--neon-magenta);">0</span>
                </div>
                <div id="events-content">
                    <div class="loading">Loading events...</div>
                </div>
            </div>
        </section>

        <!-- Pods Error Monitoring Section -->
        <section class="argocd-section tab-content" data-tab="pods" style="display: none;">
            <h2 class="section-title">üê≥ Pods in Error</h2>

            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-box">
                    <div class="stat-value" id="pods-total">-</div>
                    <div class="stat-label">Total Pods</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="pods-running">-</div>
                    <div class="stat-label">Running</div>
                </div>
                <div class="stat-box warning">
                    <div class="stat-value" id="pods-pending">-</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="pods-error">-</div>
                    <div class="stat-label">In Error</div>
                </div>
            </div>

            <div class="issues-table-container" id="pods-container" style="border-color: var(--neon-orange, #ff8c00);">
                <div class="issues-table-header"
                    style="background: rgba(255, 140, 0, 0.1); border-color: var(--neon-orange, #ff8c00);">
                    <span class="issues-table-title" style="color: var(--neon-orange, #ff8c00);">‚ö†Ô∏è Pods with
                        Issues</span>
                    <span class="issues-count" id="pods-error-count"
                        style="background: var(--neon-orange, #ff8c00);">0</span>
                </div>
                <div id="pods-content">
                    <div class="loading">Loading pods status...</div>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section class="argocd-section tab-content" data-tab="chat" style="display: none;">
            <h2 class="section-title">üí¨ Kusanagi Chat</h2>

            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message bot">
                        <div class="message-content">
                            <span class="bot-header"><img src="/static/images/logo.png" class="chat-avatar"
                                    alt="Kusanagi"> <strong>Kusanagi</strong></span><br>
                            Welcome! Type <code>/help</code> for available commands, or ask me about your cluster
                            status.
                        </div>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" class="chat-input"
                        placeholder="Type a command or question... (e.g., /status, /nodes, /events)"
                        onkeypress="handleChatKeypress(event)">
                    <button class="chat-send-btn" onclick="sendChatMessage()">Send ‚û§</button>
                </div>
            </div>
        </section>

        <!-- Backups Section -->
        <section class="argocd-section tab-content" data-tab="backups" style="display: none;">
            <h2 class="section-title">üì¶ Backup Jobs Status</h2>

            <div class="stats-grid" style="margin-bottom: 1.5rem;">
                <div class="stat-box">
                    <div class="stat-value" id="backup-cronjobs">-</div>
                    <div class="stat-label">CronJobs</div>
                </div>
                <div class="stat-box warning">
                    <div class="stat-value" id="backup-active">-</div>
                    <div class="stat-label">Running</div>
                </div>
                <div class="stat-box healthy">
                    <div class="stat-value" id="backup-succeeded">-</div>
                    <div class="stat-label">Succeeded</div>
                </div>
                <div class="stat-box unhealthy">
                    <div class="stat-value" id="backup-failed">-</div>
                    <div class="stat-label">Failed</div>
                </div>
            </div>

            <div class="issues-table-container" id="backups-container" style="border-color: var(--neon-green);">
                <div class="issues-table-header"
                    style="background: rgba(0, 255, 136, 0.1); border-color: var(--neon-green);">
                    <span class="issues-table-title" style="color: var(--neon-green);">‚è∞ CronJobs & Recent Jobs</span>
                    <span class="issues-count" id="backups-count" style="background: var(--neon-green);">0</span>
                </div>
                <div id="backups-content">
                    <div class="loading">Loading backup jobs...</div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p class="footer-quote">"Your effort to remain what you are is what limits you."</p>
            <p>KUSANAGI // Ghost in the Shell Inspired // Built with ‚ö° by Rust</p>
        </footer>
    </div>

    <script>
        // === THEME TOGGLE ===
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('kusanagi-theme', newTheme);
        }

        function applyTheme(theme) {
            if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
                document.getElementById('theme-icon').textContent = '‚òÄÔ∏è';
            } else {
                document.documentElement.removeAttribute('data-theme');
                document.getElementById('theme-icon').textContent = 'üåô';
            }
        }

        // Initialize theme on page load
        (function initTheme() {
            const savedTheme = localStorage.getItem('kusanagi-theme');
            if (savedTheme) {
                applyTheme(savedTheme);
            } else {
                // Respect system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                applyTheme(prefersDark ? 'dark' : 'light');
            }
        })();

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
            if (!localStorage.getItem('kusanagi-theme')) {
                applyTheme(e.matches ? 'dark' : 'light');
            }
        });

        // === WEBSOCKET NOTIFICATIONS ===
        let wsConnection = null;
        let wsReconnectAttempts = 0;
        const WS_MAX_RECONNECT_ATTEMPTS = 5;
        const WS_RECONNECT_DELAY = 3000;

        function initWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/notifications`;

            updateWsStatus('connecting');

            try {
                wsConnection = new WebSocket(wsUrl);

                wsConnection.onopen = function () {
                    console.log('‚úÖ WebSocket connected');
                    wsReconnectAttempts = 0;
                    updateWsStatus('connected');
                };

                wsConnection.onmessage = function (event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleWsMessage(data);
                    } catch (e) {
                        console.error('Failed to parse WebSocket message:', e);
                    }
                };

                wsConnection.onclose = function (event) {
                    console.log('WebSocket closed:', event.code, event.reason);
                    updateWsStatus('disconnected');
                    attemptReconnect();
                };

                wsConnection.onerror = function (error) {
                    console.error('WebSocket error:', error);
                    updateWsStatus('disconnected');
                };
            } catch (error) {
                console.error('Failed to create WebSocket:', error);
                updateWsStatus('disconnected');
            }
        }

        function attemptReconnect() {
            if (wsReconnectAttempts < WS_MAX_RECONNECT_ATTEMPTS) {
                wsReconnectAttempts++;
                console.log(`Attempting WebSocket reconnect (${wsReconnectAttempts}/${WS_MAX_RECONNECT_ATTEMPTS})...`);
                setTimeout(initWebSocket, WS_RECONNECT_DELAY);
            } else {
                console.log('Max WebSocket reconnect attempts reached');
            }
        }

        function updateWsStatus(status) {
            const indicator = document.getElementById('ws-indicator');
            const statusEl = document.getElementById('ws-status');

            indicator.className = 'ws-indicator ' + status;

            const labels = {
                'connected': 'Live',
                'disconnected': 'Offline',
                'connecting': 'Connecting...'
            };

            statusEl.title = `WebSocket: ${labels[status] || status}`;
        }

        function handleWsMessage(data) {
            switch (data.type) {
                case 'connected':
                    console.log('WebSocket:', data.message);
                    break;

                case 'alert':
                    showNotification({
                        title: data.title,
                        message: data.message,
                        severity: data.severity,
                        source: data.source
                    });
                    break;

                case 'stats_update':
                    // Update live stats if needed
                    console.log('Stats update:', data);
                    break;

                case 'heartbeat':
                    // Silent heartbeat
                    break;

                default:
                    console.log('Unknown WebSocket message:', data);
            }
        }

        function showNotification(options) {
            const container = document.getElementById('notification-container');
            const id = 'notif-' + Date.now();

            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `notification ${options.severity || 'info'}`;

            notification.innerHTML = `
                <div class="notification-header">
                    <span class="notification-title">${getSeverityIcon(options.severity)} ${options.title}</span>
                    <button class="notification-close" onclick="dismissNotification('${id}')">&times;</button>
                </div>
                <div class="notification-body">${options.message}</div>
                ${options.source ? `<div class="notification-source">Source: ${options.source}</div>` : ''}
            `;

            container.appendChild(notification);

            // Auto-dismiss after 8 seconds
            setTimeout(() => dismissNotification(id), 8000);

            // Play sound if enabled (optional)
            // playNotificationSound(options.severity);
        }

        function dismissNotification(id) {
            const notification = document.getElementById(id);
            if (notification) {
                notification.classList.add('hiding');
                setTimeout(() => notification.remove(), 300);
            }
        }

        function getSeverityIcon(severity) {
            const icons = {
                'error': 'üî¥',
                'warning': 'üü†',
                'success': 'üü¢',
                'info': 'üîµ'
            };
            return icons[severity] || icons.info;
        }

        // Initialize WebSocket on page load
        initWebSocket();

        // Reconnect WebSocket when page becomes visible
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && (!wsConnection || wsConnection.readyState !== WebSocket.OPEN)) {
                wsReconnectAttempts = 0;
                initWebSocket();
            }
        });

        // === TAB NAVIGATION ===
        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });

            // Update content
            document.querySelectorAll('.tab-content').forEach(section => {
                if (section.dataset.tab === tabName) {
                    section.style.display = 'block';
                } else {
                    section.style.display = 'none';
                }
            });
        }

        // === CHAT FUNCTIONS ===
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            // Add user message
            addChatMessage(message, 'user');
            input.value = '';

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                addChatMessage(data.response, 'bot');
            } catch (error) {
                addChatMessage('Error: Failed to get response from server', 'bot');
            }
        }

        function addChatMessage(content, type) {
            const container = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;

            // Simple markdown to HTML conversion
            let html = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>')
                .replace(/^## (.*)/gm, '<h4>$1</h4>')
                .replace(/^- (.*)/gm, '‚Ä¢ $1<br>');

            if (type === 'user') {
                messageDiv.innerHTML = `<div class="message-content"><strong>üë§ You</strong><br>${html}</div>`;
            } else {
                messageDiv.innerHTML = `<div class="message-content"><span class="bot-header"><img src="/static/images/logo.png" class="chat-avatar" alt="Kusanagi"> <strong>Kusanagi</strong></span><br>${html}</div>`;
            }

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // === ARGOCD ===
        async function fetchArgoStatus() {
            try {
                const response = await fetch('/api/argocd/status');
                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                    return;
                }

                updateStats(data);
                updateIssuesTable(data.apps_with_issues);
                updateUpgradesTable(data.apps_with_upgrades);
            } catch (error) {
                showError('Failed to connect to ArgoCD API');
            }
        }

        function updateStats(data) {
            document.getElementById('stat-total').textContent = data.total;
            document.getElementById('stat-healthy').textContent = data.healthy;
            document.getElementById('stat-unhealthy').textContent = data.unhealthy;
            document.getElementById('stat-synced').textContent = data.synced;
            document.getElementById('stat-outofsync').textContent = data.out_of_sync;
            document.getElementById('stat-progressing').textContent = data.progressing;
            document.getElementById('stat-upgrades').textContent = data.upgrades_available || 0;
            document.getElementById('issues-count').textContent = data.apps_with_issues.length;
            document.getElementById('upgrades-count').textContent = (data.apps_with_upgrades || []).length;
        }

        function renderAppRow(app, showSync = false) {
            return `
                <tr>
                    <td class="app-name">
                        <a href="${app.argocd_url}" target="_blank" title="Open in ArgoCD" style="color: var(--neon-green); text-decoration: none;">
                            ${app.name} üîó
                        </a>
                    </td>
                    <td>${app.namespace || '-'}</td>
                    <td><span class="status-badge ${app.health_status.toLowerCase()}">${app.health_status}</span></td>
                    <td><span class="status-badge ${app.sync_status.toLowerCase().replace(' ', '')}">${app.sync_status}</span></td>
                    <td class="error-duration">${app.error_duration || '-'}</td>
                    ${showSync && app.can_sync ? `
                        <td>
                            <button class="sync-btn" onclick="syncApp('${app.name}')" title="Sync ${app.name}">
                                ‚ü≥ Sync
                            </button>
                        </td>
                    ` : `<td class="error-message" title="${app.message || ''}">${app.message || '-'}</td>`}
                </tr>
            `;
        }

        function updateIssuesTable(issues) {
            const container = document.getElementById('issues-content');

            if (!issues || issues.length === 0) {
                container.innerHTML = '<div class="no-issues">All applications are healthy!</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Namespace</th>
                            <th>Health</th>
                            <th>Sync</th>
                            <th>Duration</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${issues.map(app => renderAppRow(app, false)).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        function updateUpgradesTable(upgrades) {
            const container = document.getElementById('upgrades-content');

            if (!upgrades || upgrades.length === 0) {
                container.innerHTML = '<div class="no-issues" style="color: var(--neon-cyan);">No upgrades available</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Application</th>
                            <th>Namespace</th>
                            <th>Health</th>
                            <th>Sync</th>
                            <th>Duration</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${upgrades.map(app => renderAppRow(app, true)).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        async function syncApp(appName) {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Syncing...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/argocd/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ app_name: appName })
                });
                const data = await response.json();

                if (data.success) {
                    btn.textContent = '‚úì Done';
                    btn.style.background = 'var(--neon-green)';
                    setTimeout(() => fetchArgoStatus(), 2000);
                } else {
                    btn.textContent = '‚úó Failed';
                    btn.style.background = '#ff4444';
                    console.error(data.message);
                }
            } catch (error) {
                btn.textContent = '‚úó Error';
                btn.style.background = '#ff4444';
                console.error('Sync failed:', error);
            }

            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '';
            }, 3000);
        }

        function showError(message) {
            const container = document.getElementById('issues-content');
            container.innerHTML = `<div class="loading" style="color: #ff4444;">Error: ${message}</div>`;
        }

        // === GLOBAL VARIABLES ===
        let storageData = [];
        let storagePage = 1;
        let storagePerPage = 10;
        let storageSortField = 'usage_percent';
        let storageSortDir = 'desc';

        // Initial fetch
        fetchArgoStatus();
        fetchNodesStatus();
        fetchPodsStatus();

        // Refresh every 30 seconds
        setInterval(fetchArgoStatus, 30000);
        setInterval(fetchNodesStatus, 30000);
        setInterval(fetchPodsStatus, 30000);

        // === PODS ERROR MONITORING ===
        async function fetchPodsStatus() {
            try {
                const response = await fetch('/api/pods/status');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('pods-content').innerHTML =
                        `<div class="loading" style="color: #ff4444;">Error: ${data.error}</div>`;
                    return;
                }

                // Update stats
                document.getElementById('pods-total').textContent = data.total_pods;
                document.getElementById('pods-running').textContent = data.running_pods;
                document.getElementById('pods-pending').textContent = data.pending_pods;
                document.getElementById('pods-error').textContent = data.error_pods;
                document.getElementById('pods-error-count').textContent = data.pods_in_error.length;

                // Render table
                renderPodsTable(data.pods_in_error);
            } catch (error) {
                console.error('Failed to fetch pods status:', error);
                document.getElementById('pods-content').innerHTML =
                    `<div class="loading" style="color: #ff4444;">Failed to fetch pods status</div>`;
            }
        }

        function renderPodsTable(pods) {
            const container = document.getElementById('pods-content');

            if (!pods || pods.length === 0) {
                container.innerHTML = '<div class="no-issues" style="color: var(--neon-green);">‚úì No pods in error state!</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Pod Name</th>
                            <th>Namespace</th>
                            <th>Status</th>
                            <th>Reason</th>
                            <th>Restarts</th>
                            <th>Age</th>
                            <th>Node</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pods.map(pod => `
                            <tr>
                                <td class="app-name" title="${pod.message || ''}">${pod.name}</td>
                                <td>${pod.namespace}</td>
                                <td><span class="status-badge ${getStatusClass(pod.status)}">${pod.status}</span></td>
                                <td class="error-message" title="${pod.message || ''}">${pod.reason || '-'}</td>
                                <td style="color: ${pod.restart_count > 5 ? '#ff4444' : 'inherit'}; font-weight: ${pod.restart_count > 5 ? 'bold' : 'normal'};">${pod.restart_count}</td>
                                <td>${pod.age}</td>
                                <td>${pod.node || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        function getStatusClass(status) {
            switch (status.toLowerCase()) {
                case 'running': return 'healthy';
                case 'succeeded': return 'healthy';
                case 'pending': return 'progressing';
                case 'failed': return 'unhealthy';
                default: return 'unknown';
            }
        }

        // === NODES MONITORING ===
        async function fetchNodesStatus() {
            try {
                const response = await fetch('/api/nodes/status');
                const data = await response.json();

                if (data.error) {
                    document.getElementById('nodes-container').innerHTML =
                        `<div class="loading" style="color: #ff4444;">Error: ${data.error}</div>`;
                    return;
                }

                // Update stats
                document.getElementById('node-total').textContent = data.total_nodes;
                document.getElementById('node-ready').textContent = data.ready_nodes;
                document.getElementById('node-notready').textContent = data.not_ready_nodes;

                // Render nodes
                renderNodes(data.nodes);
            } catch (error) {
                document.getElementById('nodes-container').innerHTML =
                    `<div class="loading" style="color: #ff4444;">Failed to fetch nodes</div>`;
            }
        }

        function renderNodes(nodes) {
            const container = document.getElementById('nodes-container');

            if (!nodes || nodes.length === 0) {
                container.innerHTML = '<div class="no-issues">No nodes found</div>';
                return;
            }

            // Sort nodes alphabetically by name
            nodes.sort((a, b) => a.name.localeCompare(b.name));

            const html = nodes.map(node => {
                const archClass = node.architecture === 'arm64' ? 'arch-arm' : 'arch-amd';
                const statusClass = node.status === 'Ready' ? 'node-ready' : 'node-notready';
                const nodeType = node.labels?.type || node.labels?.['node.kubernetes.io/instance-type'] || 'node';
                const podPercent = Math.round((node.pod_count / parseInt(node.pod_capacity)) * 100);
                const podBarClass = podPercent > 80 ? 'bar-danger' : podPercent > 60 ? 'bar-warning' : 'bar-ok';

                return `
                    <div class="node-card ${statusClass} ${node.pods_in_error > 0 ? 'has-errors' : ''}">
                        <div class="node-header">
                            <div class="node-title">
                                <span class="node-name">${node.name}</span>
                                <span class="node-type">${nodeType}</span>
                            </div>
                            <span class="arch-badge ${archClass}">${node.architecture}</span>
                        </div>
                        
                        <div class="node-resources">
                            <div class="resource-row">
                                <span class="resource-icon">‚ö°</span>
                                <span class="resource-label">CPU</span>
                                <span class="resource-value">${node.cpu_capacity} cores</span>
                            </div>
                            <div class="resource-row">
                                <span class="resource-icon">üß†</span>
                                <span class="resource-label">RAM</span>
                                <span class="resource-value">${node.memory_allocatable}</span>
                            </div>
                            <div class="resource-row pods-row">
                                <span class="resource-icon">üì¶</span>
                                <span class="resource-label">Pods</span>
                                <div class="pod-bar-container">
                                    <div class="pod-bar ${podBarClass}" style="width: ${podPercent}%"></div>
                                    <span class="pod-text">${node.pod_count}/${node.pod_capacity}</span>
                                </div>
                            </div>
                        </div>

                        <div class="node-uptime">
                            <span class="uptime-icon">‚è±</span>
                            <span class="uptime-value">${node.uptime || 'Unknown'}</span>
                        </div>

                        ${node.pods_in_error > 0 ? `
                            <div class="node-errors">
                                <div class="error-header">‚ö†Ô∏è ${node.pods_in_error} pod${node.pods_in_error > 1 ? 's' : ''} in error</div>
                                <div class="error-pods">${node.error_pod_names.map(p => `<span class="error-pod">${p}</span>`).join('')}</div>
                            </div>
                        ` : ''}

                        <div class="node-footer">
                            <span class="footer-item" title="${node.kernel_version}">${node.container_runtime.split('://')[0]}</span>
                            <span class="footer-item">${node.kubelet_version}</span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="nodes-grid">${html}</div>`;
        }

        // === CLUSTER OVERVIEW ===
        async function fetchClusterOverview() {
            try {
                const response = await fetch('/api/cluster/overview');
                const data = await response.json();

                if (!data.error) {
                    // Quick nav stats
                    document.getElementById('ns-count').textContent = data.namespace_count || 0;
                    document.getElementById('pvc-count').textContent = data.pvc_count || 0;
                    document.getElementById('pvc-capacity').textContent = data.pvc_total_capacity || '-';

                    // PVC section stats
                    const pvcs = data.pvcs || [];
                    const bound = pvcs.filter(p => p.status === 'Bound').length;
                    const pending = pvcs.filter(p => p.status !== 'Bound').length;

                    document.getElementById('pvc-total-count').textContent = data.pvc_count || 0;
                    document.getElementById('pvc-bound-count').textContent = bound;
                    document.getElementById('pvc-pending-count').textContent = pending;
                    document.getElementById('pvc-total-storage').textContent = data.pvc_total_capacity || '-';
                    document.getElementById('pvc-table-count').textContent = pvcs.length;

                    /* Document count updated by storage fetch now */
                }
            } catch (error) {
                console.error('Failed to fetch cluster overview:', error);
            }
        }

        // === STORAGE MONITORING ===
        async function fetchStorageStatus() {
            try {
                const response = await fetch('/api/storage');
                const data = await response.json();

                if (!data.error) {
                    storageData = data.pvcs || [];
                    document.getElementById('pvc-table-count').textContent = storageData.length;
                    renderStorageTable();
                }
            } catch (error) {
                console.error('Failed to fetch storage status:', error);
                document.getElementById('pvc-content').innerHTML =
                    '<div class="loading" style="color: #ff4444;">Failed to fetch storage data</div>';
            }
        }

        function renderStorageTable() {
            const container = document.getElementById('pvc-content');

            if (!storageData || storageData.length === 0) {
                container.innerHTML = '<div class="no-issues" style="color: var(--neon-cyan);">No PVCs found</div>';
                return;
            }

            // Sort
            const sortedData = [...storageData].sort((a, b) => {
                let valA = a[storageSortField];
                let valB = b[storageSortField];

                // Handle nulls
                if (valA === null || valA === undefined) valA = -1;
                if (valB === null || valB === undefined) valB = -1;

                if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return storageSortDir === 'asc' ? -1 : 1;
                if (valA > valB) return storageSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Pagination
            const totalPages = Math.ceil(sortedData.length / storagePerPage);
            if (storagePage > totalPages) storagePage = totalPages || 1;
            const start = (storagePage - 1) * storagePerPage;
            const end = start + storagePerPage;
            const pageData = sortedData.slice(start, end);

            // Render Table
            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th onclick="sortStorage('name')" class="sortable">Name ${getSortArrow('name')}</th>
                            <th onclick="sortStorage('namespace')" class="sortable">Namespace ${getSortArrow('namespace')}</th>
                            <th onclick="sortStorage('capacity_bytes')" class="sortable">Capacity ${getSortArrow('capacity_bytes')}</th>
                            <th onclick="sortStorage('usage_percent')" class="sortable">Usage ${getSortArrow('usage_percent')}</th>
                            <th onclick="sortStorage('status')" class="sortable">Status ${getSortArrow('status')}</th>
                            <th>Class</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${pageData.map(pvc => {
                const percent = pvc.usage_percent || 0;
                const barClass = percent > 90 ? 'bar-danger' : percent > 75 ? 'bar-warning' : 'bar-ok';
                const usedStr = formatBytes(pvc.used_bytes) || '?';

                return `
                            <tr>
                                <td class="app-name">${pvc.name}</td>
                                <td>${pvc.namespace}</td>
                                <td>${pvc.capacity}</td>
                                <td>
                                    <div class="usage-cell">
                                        <div class="pod-bar-container" title="${usedStr} / ${pvc.capacity}">
                                            <div class="pod-bar ${barClass}" style="width: ${Math.min(percent, 100)}%"></div>
                                        </div>
                                        <span class="usage-text">${percent.toFixed(1)}%</span>
                                    </div>
                                </td>
                                <td><span class="status-badge ${pvc.status.toLowerCase()}">${pvc.status}</span></td>
                                <td class="storage-class">${pvc.storage_class || '-'}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
                
                <!-- Pagination Controls -->
                <div class="pagination-controls">
                    <button ${storagePage === 1 ? 'disabled' : ''} onclick="changeStoragePage(-1)" class="page-btn">‚óÄ</button>
                    <span class="page-info">Page ${storagePage} of ${totalPages} (${sortedData.length} items)</span>
                    <button ${storagePage === totalPages ? 'disabled' : ''} onclick="changeStoragePage(1)" class="page-btn">‚ñ∂</button>
                    <select onchange="updateStoragePerPage(this.value)" class="per-page-select">
                        <option value="10" ${storagePerPage === 10 ? 'selected' : ''}>10</option>
                        <option value="20" ${storagePerPage === 20 ? 'selected' : ''}>20</option>
                        <option value="50" ${storagePerPage === 50 ? 'selected' : ''}>50</option>
                    </select>
                </div>
            `;
            container.innerHTML = table;
        }

        function sortStorage(field) {
            if (storageSortField === field) {
                storageSortDir = storageSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                storageSortField = field;
                storageSortDir = 'desc'; // Default to desc for new field (esp numbers)
            }
            renderStorageTable();
        }

        function getSortArrow(field) {
            if (storageSortField !== field) return '';
            return storageSortDir === 'asc' ? '‚ñ≤' : '‚ñº';
        }

        function changeStoragePage(delta) {
            storagePage += delta;
            renderStorageTable();
        }

        function updateStoragePerPage(val) {
            storagePerPage = parseInt(val);
            storagePage = 1;
            renderStorageTable();
        }

        function formatBytes(bytes) {
            if (!bytes && bytes !== 0) return null;
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KiB', 'MiB', 'GiB', 'TiB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        // === KUBERNETES EVENTS ===
        async function fetchEvents() {
            try {
                const response = await fetch('/api/events');
                const data = await response.json();

                if (!data.error) {
                    document.getElementById('events-total').textContent = data.total_events || 0;
                    document.getElementById('events-warnings').textContent = data.warning_count || 0;
                    document.getElementById('events-normal').textContent = data.normal_count || 0;
                    document.getElementById('events-table-count').textContent = data.events?.length || 0;

                    renderEventsTable(data.events || []);
                }
            } catch (error) {
                console.error('Failed to fetch events:', error);
            }
        }

        function renderEventsTable(events) {
            const container = document.getElementById('events-content');

            if (!events || events.length === 0) {
                container.innerHTML = '<div class="no-issues" style="color: var(--neon-magenta);">No events in the last hour ‚úì</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Object</th>
                            <th>Reason</th>
                            <th>Message</th>
                            <th>Age</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${events.slice(0, 30).map(evt => `
                            <tr class="${evt.event_type.toLowerCase()}">
                                <td><span class="event-type ${evt.event_type.toLowerCase()}">${evt.event_type}</span></td>
                                <td class="event-object">${evt.involved_object_kind}/${evt.involved_object_name.substring(0, 30)}${evt.involved_object_name.length > 30 ? '...' : ''}</td>
                                <td class="event-reason">${evt.reason}</td>
                                <td class="event-message" title="${evt.message}">${evt.message.substring(0, 60)}${evt.message.length > 60 ? '...' : ''}</td>
                                <td class="event-age">${evt.age || '-'}</td>
                                <td class="event-count">${evt.count}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                ${events.length > 30 ? `<div class="table-footer">Showing 30 of ${events.length} events</div>` : ''}
            `;
            container.innerHTML = table;
        }

        // === BACKUPS ===
        async function fetchBackupsStatus() {
            try {
                const response = await fetch('/api/backups');
                const data = await response.json();

                if (!data.error) {
                    document.getElementById('backup-cronjobs').textContent = data.total_cronjobs || 0;
                    document.getElementById('backup-active').textContent = data.active_jobs || 0;
                    document.getElementById('backup-succeeded').textContent = data.succeeded_jobs || 0;
                    document.getElementById('backup-failed').textContent = data.failed_jobs || 0;
                    document.getElementById('backups-count').textContent = data.total_cronjobs || 0;

                    renderBackupsTable(data.cronjobs || []);
                }
            } catch (error) {
                console.error('Failed to fetch backups:', error);
                document.getElementById('backups-content').innerHTML =
                    '<div class="loading" style="color: #ff4444;">Failed to load backups</div>';
            }
        }

        function renderBackupsTable(cronjobs) {
            const container = document.getElementById('backups-content');

            if (!cronjobs || cronjobs.length === 0) {
                container.innerHTML = '<div class="no-issues" style="color: var(--neon-green);">No CronJobs found</div>';
                return;
            }

            const table = `
                <table class="issues-table">
                    <thead>
                        <tr>
                            <th>CronJob</th>
                            <th>Namespace</th>
                            <th>Schedule</th>
                            <th>Last Run</th>
                            <th>Status</th>
                            <th>Recent Jobs</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cronjobs.map(cj => {
                const statusClass = cj.suspend ? 'suspended' : (cj.active_jobs > 0 ? 'running' : 'healthy');
                const statusText = cj.suspend ? 'Suspended' : (cj.active_jobs > 0 ? 'Running' : 'Idle');

                const recentJobs = (cj.recent_jobs || []).slice(0, 3).map(job => {
                    const jobClass = job.status.toLowerCase();
                    return `<span class="job-badge ${jobClass}" title="${job.name}\nDuration: ${job.duration || '-'}">${job.status === 'Succeeded' ? '‚úì' : job.status === 'Failed' ? '‚úó' : '‚óè'}</span>`;
                }).join(' ');

                return `
                                <tr>
                                    <td class="app-name">${cj.name}</td>
                                    <td>${cj.namespace}</td>
                                    <td><code class="schedule">${cj.schedule}</code></td>
                                    <td class="last-run">${cj.last_schedule_age || '-'}</td>
                                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                    <td class="recent-jobs">${recentJobs || '-'}</td>
                                </tr>
                            `;
            }).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        async function fetchServices() {
            try {
                const response = await fetch('/api/services');
                if (!response.ok) throw new Error('Failed to fetch services');
                const data = await response.json();
                document.getElementById('services-count').textContent = data.length;
                renderServicesTable(data);
            } catch (error) {
                console.error('Error fetching services:', error);
                document.getElementById('services-content').innerHTML = `
                    <div class="error-state">
                        Failed to load services data: ${error.message}
                    </div>
                `;
            }
        }

        function renderServicesTable(services) {
            const container = document.getElementById('services-content');
            if (services.length === 0) {
                container.innerHTML = '<div class="no-issues">No services found</div>';
                return;
            }

            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Namespace</th>
                            <th>Type</th>
                            <th>Cluster IP</th>
                            <th>External IP</th>
                            <th>Ports</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${services.map(svc => `
                            <tr>
                                <td class="app-name">${svc.name}</td>
                                <td>${svc.namespace}</td>
                                <td><span class="status-badge info">${svc.type_}</span></td>
                                <td><code>${svc.cluster_ip}</code></td>
                                <td>${svc.external_ip ? `<code>${svc.external_ip}</code>` : '-'}</td>
                                <td>${svc.ports}</td>
                                <td>${svc.age}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        async function fetchIngress() {
            try {
                const response = await fetch('/api/ingress');
                if (!response.ok) throw new Error('Failed to fetch ingress');
                const data = await response.json();
                document.getElementById('ingress-count').textContent = data.length;
                renderIngressTable(data);
            } catch (error) {
                console.error('Error fetching ingress:', error);
                document.getElementById('ingress-content').innerHTML = `
                    <div class="error-state">
                        Failed to load ingress data: ${error.message}
                    </div>
                `;
            }
        }

        function renderIngressTable(ingresses) {
            const container = document.getElementById('ingress-content');
            if (ingresses.length === 0) {
                container.innerHTML = '<div class="no-issues">No ingress rules found</div>';
                return;
            }

            const table = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Namespace</th>
                            <th>Load Balancer</th>
                            <th>Rules</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${ingresses.map(ing => `
                            <tr>
                                <td class="app-name">${ing.name}</td>
                                <td>${ing.namespace}</td>
                                <td>${ing.load_balancer ? `<code>${ing.load_balancer}</code>` : '-'}</td>
                                <td>
                                    <div class="ingress-rules">
                                        ${ing.rules.map(rule => {
                // Extract hostname from rule (format: "host/path -> service:port")
                const hostMatch = rule.match(/^([^\/]+)/);
                const host = hostMatch ? hostMatch[1].trim() : null;
                if (host && host !== '*') {
                    return `<div><a href="https://${host}" target="_blank" rel="noopener" class="ingress-link" title="Open ${host}">üîó ${rule}</a></div>`;
                }
                return `<div><code>${rule}</code></div>`;
            }).join('')}
                                    </div>
                                </td>
                                <td>${ing.age}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = table;
        }

        // Initialize RUM tracking
        if (typeof KusanagiRUM !== 'undefined') {
            KusanagiRUM.init({
                serviceName: 'kusanagi',
                serviceVersion: '0.6.0',
                environment: 'production',
                debug: false
            });
        }

        // Initial fetches
        fetchArgoStatus();
        fetchNodesStatus();
        fetchClusterOverview();
        fetchEvents();
        fetchBackupsStatus();
        fetchStorageStatus();
        fetchServices();
        fetchIngress();

        // Refresh intervals
        setInterval(fetchArgoStatus, 30000);
        setInterval(fetchNodesStatus, 30000);
        setInterval(fetchClusterOverview, 60000);
        setInterval(fetchEvents, 30000);
        setInterval(fetchBackupsStatus, 60000);
        setInterval(fetchStorageStatus, 60000);
        setInterval(fetchServices, 60000);
        setInterval(fetchIngress, 60000);

        // Track session stats every 5 minutes
        setInterval(() => {
            if (typeof KusanagiRUM !== 'undefined') {
                const stats = KusanagiRUM.getSessionStats();
                console.log('üìä Session Stats:', stats);
            }
        }, 300000);
    </script>
</body>

</html>